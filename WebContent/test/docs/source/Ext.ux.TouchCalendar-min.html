<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/*
 * Ext.ux.TouchCalendar
 */
Ext.define(&quot;Ext.ux.TouchCalendar&quot;,{extend:&quot;Ext.carousel.Carousel&quot;,xtype:&quot;calendar&quot;,config:{viewMode:&quot;month&quot;,enableSwipeNavigate:true,enableSimpleEvents:false,enableEventBars:false,viewConfig:{}},defaultViewConfig:{viewMode:&quot;MONTH&quot;,weekStart:1,bubbleEvents:[&quot;selectionchange&quot;]},indicator:false,initialize:function(){this.viewConfig=Ext.applyIf(this.viewConfig||{},this.defaultViewConfig);this.viewConfig.currentDate=this.viewConfig.currentDate||this.viewConfig.value||new Date();this.setViewMode(this.viewConfig.viewMode.toUpperCase());this.initViews();Ext.apply(this,{cls:&quot;touch-calendar&quot;,activeItem:(this.getEnableSwipeNavigate()?1:0),direction:&quot;horizontal&quot;});this.setIndicator(false);this.setActiveItem(1);this.on(&quot;selectionchange&quot;,this.onSelectionChange);this.on(&quot;activeitemchange&quot;,this.onActiveItemChange);if(this.getEnableSwipeNavigate()){this.on(this.element,{drag:this.onDrag,dragThreshold:5,dragend:this.onDragEnd,direction:this.direction,scope:this});this.element.addCls(this.baseCls+&quot;-&quot;+this.direction)}},getViewConfig:function(c){var a=[];if(this.getEnableSimpleEvents()){var b=Ext.isObject(this.getEnableSimpleEvents())?this.getEnableSimpleEvents():{};a.push(Ext.create(&quot;Ext.ux.TouchCalendarSimpleEvents&quot;,b))}else{if(this.getEnableEventBars()){var b=Ext.isObject(this.getEnableEventBars())?this.getEnableEventBars():{};a.push(Ext.create(&quot;Ext.ux.TouchCalendarEvents&quot;,b))}}Ext.apply(this._viewConfig,{plugins:a,currentDate:c,viewMode:this.getViewMode(),onTableHeaderTap:Ext.bind(this.onTableHeaderTap,this),bubbleEvents:[&quot;periodchange&quot;,&quot;eventtap&quot;,&quot;selectionchange&quot;]});return this._viewConfig},getViewDate:function(a,b){var d=(this.getViewMode()===&quot;WEEK&quot;?&quot;DAY&quot;:this.getViewMode().toUpperCase()),c=(this.getViewMode()===&quot;WEEK&quot;?(8*b):b);return Ext.Date.add(a,Ext.Date[d],c)},initViews:function(){var c=[];var f=Ext.Date.clone(this.viewConfig.currentDate),d=(this.getEnableSwipeNavigate()?-1:0),a=(this.getEnableSwipeNavigate()?1:0),b=[];var e=this.getViewDate(f,-1);c.push(Ext.create(&quot;Ext.ux.TouchCalendarView&quot;,Ext.applyIf({currentDate:e},this.getViewConfig(e))));c.push(Ext.create(&quot;Ext.ux.TouchCalendarView&quot;,Ext.ux.TouchCalendarView(this.getViewConfig(f))));e=this.getViewDate(f,1);c.push(Ext.create(&quot;Ext.ux.TouchCalendarView&quot;,Ext.ux.TouchCalendarView(Ext.applyIf({currentDate:e},this.getViewConfig(e)))));this.setItems(c);this.view=c[(this.getEnableSwipeNavigate()?1:0)]},onTableHeaderTap:function(b,a){a=Ext.fly(a);if(a.hasCls(this.view.getPrevPeriodCls())||a.hasCls(this.view.getNextPeriodCls())){this[(a.hasCls(this.view.getPrevPeriodCls())?&quot;previous&quot;:&quot;next&quot;)]()}},applyViewMode:function(a){return a.toUpperCase()},updateViewMode:function(a){this.viewConfig=this.viewConfig||{};this.viewConfig.viewMode=a;if(this.view){Ext.each(this.getInnerItems(),function(b,c){b.currentDate=this.getViewDate(Ext.Date.clone(this.view.currentDate),c-1);b.setViewMode(a,true);b.refresh()},this)}},getValue:function(){var a=this.view.getSelected();return(a.length&gt;0)?a:null},setValue:function(a){this.view.setValue(a)},onActiveItemChange:function(a,g,b){if(this.getEnableSwipeNavigate()){var d=this.getItems();var h=d.indexOf(g),e=d.indexOf(b),f=(h&gt;e)?&quot;forward&quot;:&quot;backward&quot;;this.counter=(this.counter||0)+1;if(f===&quot;forward&quot;){this.remove(d.get(0));var c=new Ext.ux.TouchCalendarView(this.getViewConfig(this.getViewDate(g.currentDate,1)));this.add(c)}else{this.remove(d.get(d.getCount()-1));var c=new Ext.ux.TouchCalendarView(this.getViewConfig(this.getViewDate(g.currentDate,-1)));this.insert(0,c)}this.view=g;var i=this.view.getPeriodMinMaxDate();this.fireEvent(&quot;periodchange&quot;,this.view,i.min.get(&quot;date&quot;),i.max.get(&quot;date&quot;),f)}}});Ext.define(&quot;Ext.ux.TouchCalendarView&quot;,{extend:&quot;Ext.Container&quot;,alias:&quot;widget.touchcalendarview&quot;,config:{viewMode:&quot;month&quot;,weekStart:1,todayCls:&quot;today&quot;,selectedItemCls:&quot;selected&quot;,unselectableCls:&quot;unselectable&quot;,prevMonthCls:&quot;prev-month&quot;,nextMonthCls:&quot;next-month&quot;,weekendCls:&quot;weekend&quot;,prevPeriodCls:&quot;goto-prev&quot;,nextPeriodCls:&quot;goto-next&quot;,dayTimeSlotSize:30,timeSlotDateTpls:{},hideHalfHourTimeSlotLabels:true,value:null,store:null,baseTpl:['&lt;table class=&quot;{[this.me.getViewMode().toLowerCase()]}&quot;&gt;',&quot;&lt;thead&gt;&quot;,&quot;&lt;tr&gt;&quot;,'&lt;tpl for=&quot;this.getDaysArray(values)&quot;&gt;','&lt;th class=&quot;{[this.getHeaderClass(xindex)]}&quot;&gt;','&lt;tpl if=&quot;xindex === 4&quot;&gt;','&lt;span&gt;{[Ext.Date.format(this.me.currentDate, &quot;F&quot;)]} {[Ext.Date.format(this.me.currentDate, &quot;Y&quot;)]}&lt;/span&gt;',&quot;&lt;/tpl&gt;&quot;,'{date:date(&quot;D&quot;)}',&quot;&lt;/th&gt;&quot;,&quot;&lt;/tpl&gt;&quot;,&quot;&lt;/tr&gt;&quot;,&quot;&lt;/thead&gt;&quot;,&quot;&lt;tbody&gt;&quot;,'&lt;tr class=&quot;time-block-row&quot;&gt;','&lt;tpl for=&quot;.&quot;&gt;','&lt;td class=&quot;time-block {[this.getClasses(values)]}&quot; datetime=&quot;{[this.me.getDateAttribute(values.date)]}&quot;&gt;',&quot;{date:this.formatDate()}&quot;,&quot;&lt;/td&gt;&quot;,'&lt;tpl if=&quot;this.isEndOfRow(xindex)&quot;&gt;',&quot;&lt;/tr&gt;&quot;,'&lt;tpl if=&quot;!this.isEndOfPeriod(xindex)&quot;&gt;',&quot;&lt;tr&gt;&quot;,&quot;&lt;/tpl&gt;&quot;,&quot;&lt;/tpl&gt;&quot;,&quot;&lt;/tpl&gt;&quot;,&quot;&lt;/tr&gt;&quot;,&quot;&lt;/tbody&gt;&quot;,&quot;&lt;/table&gt;&quot;],cls:&quot;touch-calendar-view&quot;,itemSelector:&quot;td.time-block&quot;},timeSlotDateTplsDefaults:{day:'&lt;span class=&quot;hour&quot;&gt;{date:date(&quot;g&quot;)}&lt;/span&gt;&lt;span class=&quot;am-pm&quot;&gt;{date:date(&quot;A&quot;)}&lt;/span&gt;',month:'{date:date(&quot;j&quot;)}',week:'{date:date(&quot;j&quot;)}'},commonTemplateFunctions:{getTimeSlotRowCls:function(b){var c=[],a=b.getMinutes()!==0;if(a){c.push(&quot;half-hour&quot;)}return c.join(&quot; &quot;)},isHalfHour:function(a){return a.getMinutes()!==0},formatDate:function(a){return this.getTimeSlotDateTpl().apply({date:a})},getTimeSlotDateTpl:function(){var a=this.me.getViewMode().toLowerCase();return this.me.getTimeSlotDateTpls()[a]},getClasses:function(a){var b=[];if(a.selected){b.push(this.me.getSelectedItemCls())}if(a.unselectable){b.push(this.me.getUnselectableCls())}if(a.prevMonth){b.push(this.me.getPrevMonthCls())}if(a.nextMonth){b.push(this.me.getNextMonthCls())}if(a.weekend){b.push(this.me.getWeekendCls())}if(a.today){b.push(this.me.getTodayCls())}return b.join(&quot; &quot;)},isEndOfRow:function(a){return(a%7)===0&amp;&amp;(a&gt;0)},isStartOfRow:function(a){return((a-1)%7)===0&amp;&amp;(a-1&gt;=0)},isEndOfPeriod:function(a){return a%this.me.periodRowDayCount===0},getDaysArray:function(a){var c=[],b;for(b=0;b&lt;this.me.periodRowDayCount;b++){c.push(a[b])}return c},getHeaderClass:function(a){return a===1?this.me.getPrevPeriodCls():a===7?this.me.getNextPeriodCls():&quot;&quot;}},constructor:function(b){this.initModel();var a=Ext.create(&quot;Ext.data.Store&quot;,{model:&quot;TouchCalendarViewModel&quot;});this.setStore(a);b.timeSlotDateTpls=b.timeSlotDateTpls||{};Ext.applyIf(b.timeSlotDateTpls,this.timeSlotDateTplsDefaults);Ext.apply(this,b||{});this.callParent(arguments);this.minDate=this.minDate?Ext.Date.clearTime(this.minDate,true):null;this.maxDate=this.maxDate?Ext.Date.clearTime(this.maxDate,true):null;this.refresh()},initialize:function(){this.element.on({tap:this.onTableHeaderTap,scope:this,delegate:&quot;th&quot;});this.element.on({tap:this.onTimeSlotTap,scope:this,delegate:this.getItemSelector()});this.on({painted:this.syncHeight,resize:this.onComponentResize,scope:this});this.callParent()},initModel:function(){if(!Ext.ModelManager.isRegistered(&quot;TouchCalendarViewModel&quot;)){Ext.define(&quot;TouchCalendarViewModel&quot;,{extend:&quot;Ext.data.Model&quot;,config:{fields:[{name:&quot;date&quot;,type:&quot;date&quot;},{name:&quot;today&quot;,type:&quot;boolean&quot;},{name:&quot;unselectable&quot;,type:&quot;boolean&quot;},{name:&quot;selected&quot;,type:&quot;boolean&quot;},{name:&quot;prevMonth&quot;,type:&quot;boolean&quot;},{name:&quot;nextMonth&quot;,type:&quot;boolean&quot;},{name:&quot;weekend&quot;,type:&quot;boolean&quot;},&quot;timeSlots&quot;]}})}},updateViewMode:function(a,c){this.refresh();var b=this.getPeriodMinMaxDate();this.fireEvent(&quot;periodchange&quot;,this,b.min.get(&quot;date&quot;),b.max.get(&quot;date&quot;),&quot;none&quot;)},applyViewMode:function(b){b=b.toUpperCase();var a=Ext.ux.TouchCalendarView[b.toUpperCase()];this.getStartDate=a.getStartDate;this.getTotalDays=a.getTotalDays;this.dateAttributeFormat=a.dateAttributeFormat;this.getNextIterationDate=a.getNextIterationDate;this.getDeltaDate=a.getDeltaDate;this.periodRowDayCount=a.periodRowDayCount;Ext.apply(this.commonTemplateFunctions,{me:this});this.setTpl(new Ext.XTemplate((a.tpl||this.getBaseTpl()).join(&quot;&quot;),this.commonTemplateFunctions));this.setScrollable({direction:b.toUpperCase()===&quot;DAY&quot;?&quot;vertical&quot;:false,directionLock:true});return b},collectData:function(a){var b=[];Ext.each(a,function(c,d){b.push(c.data)},this);return b},populateStore:function(){this.currentDate=this.currentDate||this.value||new Date();var d=true,e=this.currentDate,c=this.getStartDate(e),f=this.getTotalDays(e),a;this.getStore().suspendEvents();this.getStore().data.clear();for(var b=0;b&lt;f;b++){c=this.getNextIterationDate(c,(b===0?0:1));d=(this.minDate&amp;&amp;c&lt;this.minDate)||(this.maxDate&amp;&amp;c&gt;this.maxDate);a=Ext.create(&quot;TouchCalendarViewModel&quot;,{today:this.isSameDay(c,new Date()),unselectable:d,selected:this.isSameDay(c,this.value)&amp;&amp;!d,prevMonth:(c.getMonth()&lt;e.getMonth()),nextMonth:(c.getMonth()&gt;e.getMonth()),weekend:this.isWeekend(c),date:c});this.getStore().add(a)}this.getStore().resumeEvents()},refreshDelta:function(d){var b=this.currentDate||new Date();var a=this.getDeltaDate(b,d);if(this.isOutsideMinMax(a)){return}this.currentDate=a;this.refresh();var c=this.getPeriodMinMaxDate();this.fireEvent(&quot;periodchange&quot;,this,c.min.get(&quot;date&quot;),c.max.get(&quot;date&quot;),(d&gt;0?&quot;forward&quot;:&quot;back&quot;))},getPeriodMinMaxDate:function(){return{min:this.getStore().data.first(),max:this.getStore().data.last()}},isOutsideMinMax:function(a){var b=false;if(this.getViewMode()===&quot;MONTH&quot;){b=((this.minDate&amp;&amp;Ext.Date.getLastDateOfMonth(a)&lt;this.minDate)||(this.maxDate&amp;&amp;Ext.Date.getFirstDateOfMonth(a)&gt;this.maxDate))}else{b=((this.minDate&amp;&amp;this.getWeekendDate(a)&lt;this.minDate)||(this.maxDate&amp;&amp;this.getStartDate(a)&gt;this.maxDate))}return b},onTableHeaderTap:function(b,a){a=Ext.fly(a);if(a.hasCls(this.getPrevPeriodCls())||a.hasCls(this.getNextPeriodCls())){this.refreshDelta(a.hasCls(this.getPrevPeriodCls())?-1:1)}},onTimeSlotTap:function(d){if(!d.getTarget(&quot;.&quot;+this.getUnselectableCls())){var c=Ext.fly(d.getTarget());this.selectCell(c);var b=this.getCellDate(c);var a=this.getValue()||this.currentDate;if(b.getTime()!==a.getTime()){this.setValue(b);this.fireEvent(&quot;selectionchange&quot;,this,b,a)}}},onComponentResize:function(a){this.syncHeight()},refresh:function(){this.populateStore();var a=this.getStore().getRange();this.setData(this.collectData(a));this.syncHeight()},syncHeight:function(){if(this.getViewMode().toUpperCase()!==&quot;DAY&quot;){var a=this.element.select(&quot;table&quot;,this.element.dom).first();if(a){a.setHeight(this.element.getHeight())}}},selectCell:function(a){var b=this.getSelectedItemCls();var c=this.element.select(&quot;.&quot;+b,this.element.dom);if(c){c.removeCls(b)}a.addCls(b);a.up(&quot;tr&quot;).addCls(b)},getDateRecord:function(a){return this.getStore().findBy(function(b){var c=Ext.Date.clearTime(b.get(&quot;date&quot;),true).getTime();return c===Ext.Date.clearTime(a,true).getTime()},this)},getDayStartDate:function(a){return a},isSameDay:function(b,a){if(!b||!a){return false}return Ext.Date.clearTime(b,true).getTime()===Ext.Date.clearTime(a,true).getTime()},isWeekend:function(a){return a.getDay()===0||a.getDay()===6},getWeekendDate:function(b){var a=b.getDay()-this.getWeekStart();a=a&lt;0?6:a;return new Date(b.getFullYear(),b.getMonth(),b.getDate()+0+a)},getCellDate:function(b){var a=b.dom.getAttribute(&quot;datetime&quot;);return this.stringToDate(a)},getDateCell:function(a){return this.element.select('td[datetime=&quot;'+this.getDateAttribute(a)+'&quot;]',this.element.dom).first()},getDateAttribute:function(a){return Ext.Date.format(a,this.dateAttributeFormat)},getSelected:function(){var a=this.element.select(&quot;td.&quot;+this.getSelectedItemCls(),this.element.dom),b=[];a.each(function(c){b.push(this.getCellDate(c))},this);return b},stringToDate:function(a){return Ext.Date.parseDate(a,this.dateAttributeFormat)},applyTimeSlotDateTpls:function(a){Ext.Object.each(a,function(b,c){if(Ext.isString){a[b]=Ext.create(&quot;Ext.XTemplate&quot;,c)}},this);return a},statics:{MONTH:{dateAttributeFormat:&quot;d-m-Y&quot;,getNextIterationDate:function(b,a){return new Date(b.getFullYear(),b.getMonth(),b.getDate()+(a===0?0:1))},getTotalDays:function(a){var b=Ext.Date.getFirstDateOfMonth(a);return this.isWeekend(b)?42:35},getStartDate:function(a){return Ext.bind(Ext.ux.TouchCalendarView.WEEK.getStartDate,this)(new Date(a.getFullYear(),a.getMonth(),1))},getDeltaDate:function(b,d){var c=b.getMonth()+d,a=new Date(b.getFullYear(),c,1);a.setDate(Ext.Date.getDaysInMonth(a)&lt;b.getDate()?Ext.Date.getDaysInMonth(a):b.getDate());return a},periodRowDayCount:7},WEEK:{dateAttributeFormat:&quot;d-m-Y&quot;,getNextIterationDate:function(b,a){return new Date(b.getFullYear(),b.getMonth(),b.getDate()+(a===0?0:1))},getTotalDays:function(a){return 7},getStartDate:function(b){var a=b.getDay()-this.getWeekStart();a=a&lt;0?6:a;return new Date(b.getFullYear(),b.getMonth(),b.getDate()-0-a)},getDeltaDate:function(a,b){return new Date(a.getFullYear(),a.getMonth(),a.getDate()+(b*7))},periodRowDayCount:7},DAY:{dateAttributeFormat:&quot;d-m-Y H:i&quot;,tpl:['&lt;table class=&quot;{[this.me.getViewMode().toLowerCase()]}&quot;&gt;',&quot;&lt;thead&gt;&quot;,&quot;&lt;tr&gt;&quot;,'&lt;th class=&quot;{[this.me.getPrevPeriodCls()]} style=&quot;display: block;&quot;&gt;',&quot;&lt;/th&gt;&quot;,&quot;&lt;th&gt;&quot;,'&lt;span&gt;{[Ext.Date.format(values[0].date, &quot;D jS M Y&quot;)]}&lt;/span&gt;',&quot;&lt;/th&gt;&quot;,'&lt;th class=&quot;{[this.me.getNextPeriodCls()]} style=&quot;display: block;&quot;&quot;&gt;',&quot;&lt;/th&gt;&quot;,&quot;&lt;/tr&gt;&quot;,&quot;&lt;/thead&gt;&quot;,&quot;&lt;tbody&gt;&quot;,&quot;&lt;tr&gt;&quot;,'&lt;td colspan=&quot;3&quot;&gt;','&lt;table class=&quot;time-slot-table&quot;&gt;','&lt;tpl for=&quot;.&quot;&gt;','&lt;tr class=&quot;{[this.getTimeSlotRowCls(values.date)]}&quot;&gt;','&lt;td class=&quot;label&quot;&gt;','&lt;tpl if=&quot;!this.me.getHideHalfHourTimeSlotLabels() || !this.isHalfHour(values.date)&quot;&gt;',&quot;{date:this.formatDate()}&quot;,&quot;&lt;/tpl&gt;&quot;,&quot;&lt;/td&gt;&quot;,'&lt;td class=&quot;time-block&quot; colspan=&quot;2&quot; datetime=&quot;{[this.me.getDateAttribute(values.date)]}&quot;&gt;',&quot;&lt;/td&gt;&quot;,&quot;&lt;/tr&gt;&quot;,&quot;&lt;/tpl&gt;&quot;,&quot;&lt;/table&gt;&quot;,&quot;&lt;/td&gt;&quot;,&quot;&lt;/tr&gt;&quot;,&quot;&lt;/tbody&gt;&quot;,&quot;&lt;/table&gt;&quot;],getNextIterationDate:function(b,a){var c=b.getTime()+((a===0?0:1)*(this.getDayTimeSlotSize()*60*1000));return new Date(c)},getTotalDays:function(a){return 1440/this.getDayTimeSlotSize()},getStartDate:function(a){return Ext.Date.clearTime(a,true)},getDeltaDate:function(a,b){return new Date(a.getFullYear(),a.getMonth(),a.getDate()+b)},periodRowDayCount:1}}});Ext.define(&quot;Ext.ux.TouchCalendarEventsBase&quot;,{extend:&quot;Ext.Base&quot;,config:{calendar:null,plugin:null,eventsPerTimeSlot:{},eventSortDirection:&quot;DESC&quot;},constructor:function(a){this.initConfig(a);this.callParent(arguments)},generateEventBars:function(){this.eventBarStore=Ext.create(&quot;Ext.data.Store&quot;,{model:&quot;Ext.ux.CalendarEventBarModel&quot;,data:[]});this.setEventsPerTimeSlot({});var d=this.getCalendar().getStore(),b=this.getCalendar().eventStore,a,c=0;d.each(function(f){var e=f.get(&quot;date&quot;),g=e.getTime(),h=[];b.sort(this.getPlugin().getStartEventField(),this.getEventSortDirection());b.each(function(j){if(!this.eventFilterFn.call(this,j,j.getId(),g)){return}c=c+1;var l=this.eventBarStore.findBy(function(m,n){return m.get(&quot;EventID&quot;)===j.internalId},this);if(l&gt;-1){a=this.eventBarStore.getAt(l);while(a.linked().getCount()&gt;0){a=a.linked().getAt(a.linked().getCount()-1)}if(e.getDay()===this.getCalendar().getWeekStart()){h.push(a.get(&quot;BarPosition&quot;));var i=Ext.create(&quot;Ext.ux.CalendarEventBarModel&quot;,{EventID:j.internalId,Date:e,BarLength:1,BarPosition:a.get(&quot;BarPosition&quot;),Colour:a.get(&quot;Colour&quot;),Record:j});a.linked().add(i)}else{h.push(a.get(&quot;BarPosition&quot;));a.set(&quot;BarLength&quot;,a.get(&quot;BarLength&quot;)+1)}}else{var k=this.getNextFreePosition(h);h.push(k);a=Ext.create(&quot;Ext.ux.CalendarEventBarModel&quot;,{EventID:j.internalId,Date:e,BarLength:1,BarPosition:k,Colour:this.getRandomColour(),Record:j});this.eventBarStore.add(a)}},this);if(c&gt;0){this.getEventsPerTimeSlot()[e.getTime()]=c}c=0},this)},eventBarDoesWrap:function(a){var b=Ext.Date.add(a.get(&quot;Date&quot;),Ext.Date.DAY,(a.get(&quot;BarLength&quot;)-1));return Ext.Date.clearTime(b,true).getTime()!==Ext.Date.clearTime(a.get(&quot;Record&quot;).get(this.getPlugin().getEndEventField()),true).getTime()},eventBarHasWrapped:function(a){return Ext.Date.clearTime(a.get(&quot;Date&quot;),true).getTime()!==Ext.Date.clearTime(a.get(&quot;Record&quot;).get(this.getPlugin().getStartEventField()),true).getTime()},getNextFreePosition:function(a){var b=0;while(a.indexOf(b)&gt;-1){b++}return b},createEventBar:function(c,b){var a=this.eventBarDoesWrap(c),f=this.eventBarHasWrapped(c),d=[this.getPlugin().getEventBarCls(),&quot;e-&quot;+c.get(&quot;EventID&quot;),(a?&quot; wrap-end&quot;:&quot;&quot;),(f?&quot; wrap-start&quot;:&quot;&quot;),b.get(this.getPlugin().getCssClassField())];var e=Ext.DomHelper.append(this.getPlugin().getEventWrapperEl(),{tag:&quot;div&quot;,html:this.getPlugin().getEventBarTpl().apply(b.data),eventID:c.get(&quot;EventID&quot;),cls:d.join(&quot; &quot;)},true);return e},getRandomColour:function(){return&quot;#&quot;+(Math.random()*16777215&lt;&lt;0).toString(16)}});Ext.define(&quot;Ext.ux.TouchCalendarDayEvents&quot;,{extend:&quot;Ext.ux.TouchCalendarEventsBase&quot;,config:{eventSortDirection:&quot;ASC&quot;},eventFilterFn:function(b,e,c){var a=this.getRoundedTime(b.get(this.getPlugin().getStartEventField())).getTime(),d=this.getRoundedTime(b.get(this.getPlugin().getEndEventField())).getTime();return(a&lt;=c)&amp;&amp;(d&gt;=c)},renderEventBars:function(k){var f=this,a=k.getCount(),c=0,b;for(;c&lt;a;c++){b=k.getAt(c);var g=b.data.Record,j=this.createEventBar(b,g),e=this.getEventBarWidth(b,50+10),d=this.getVerticalDayPosition(b),h=this.getHorizontalDayPosition(b,e),m=this.getEventBarHeight(b);j.setLeft(h);j.setTop(d-this.getCalendar().element.getY());j.setHeight(m);j.setWidth(e)}},getEventBarWidth:function(b,d){var c=this.getEventsPerTimeSlot()[b.get(&quot;Date&quot;).getTime()],a=this.getCalendar().element.getWidth();c=c||1;d=d||0;return Math.floor((a-d)/c)},getEventBarHeight:function(a){var b=this.getPlugin().getEventHeight();if(Ext.isNumeric(b)){return b}else{if(b===&quot;duration&quot;){return this.getEventBarHeightDuration(a)}else{return&quot;auto&quot;}}},getEventBarHeightDuration:function(a){var b=a.data.Record.get(this.getPlugin().getStartEventField()),d=a.data.Record.get(this.getPlugin().getEndEventField()),f=this.getRoundedTime(b),c=(d.getTime()-b.getTime())/1000/60,i=this.getCalendar().getDateCell(f),e=i.parent(&quot;tr&quot;,false),h=0;if(e){var g=i.getHeight(),j=g/30;h=c*j}return h},getVerticalDayPosition:function(a){var c=a.data.Record.get(this.getPlugin().getStartEventField()),i=this.getRoundedTime(c),k=(i.getHours()*2)+(i.getMinutes()===30?1:0),b=(c.getTime()-i.getTime())/1000/60,g=this.getCalendar().element.select(&quot;table.time-slot-table td&quot;,this.getCalendar().element.dom).first(),e=0;if(g){var d=g.getHeight(),f=g.getY(),j=d/30,h=b*j;e=f+(k*d)+h}return e},getHorizontalDayPosition:function(c,a){var d=c.get(&quot;BarPosition&quot;),b=50,e=this.getPlugin().getEventBarSpacing();return b+(d*a)+(d*e)},getRoundedTime:function(a){a=Ext.Date.clone(a);var b=a.getMinutes();a.setMinutes(b-(b%this.getCalendar().getDayTimeSlotSize()));a.setSeconds(0);a.setMilliseconds(0);return a}});Ext.define(&quot;Ext.ux.TouchCalendarMonthEvents&quot;,{extend:&quot;Ext.ux.TouchCalendarEventsBase&quot;,eventFilterFn:function(b,e,c){var a=Ext.Date.clearTime(b.get(this.getPlugin().getStartEventField()),true).getTime(),d=Ext.Date.clearTime(b.get(this.getPlugin().getEndEventField()),true).getTime();return(a&lt;=c)&amp;&amp;(d&gt;=c)},renderEventBars:function(a){var b=this;a.each(function(e){var k=this.getPlugin().getEventRecord(e.get(&quot;EventID&quot;)),j=this.getCalendar().getDateCell(e.get(&quot;Date&quot;)),h=this.eventBarDoesWrap(e),u=this.eventBarHasWrapped(e),f=[this.getPlugin().getEventBarCls(),&quot;e-&quot;+e.get(&quot;EventID&quot;),(h?&quot; wrap-end&quot;:&quot;&quot;),(u?&quot; wrap-start&quot;:&quot;&quot;),k.get(this.getPlugin().getCssClassField())];var m=Ext.DomHelper.append(this.getPlugin().getEventWrapperEl(),{tag:&quot;div&quot;,style:{&quot;background-color&quot;:k.get(this.getPlugin().colourField)},html:this.getPlugin().getEventBarTpl().apply(k.data),eventID:e.get(&quot;EventID&quot;),cls:f.join(&quot; &quot;)},true);if(this.allowEventDragAndDrop){new Ext.util.Draggable(m,{revert:true,onStart:function(A){var w=this,z=w.el.getAttribute(&quot;eventID&quot;),x=b.getPlugin().getEventRecord(z),y=b.getEventBarRecord(z);w.el.setWidth(w.el.getWidth()/y.get(&quot;BarLength&quot;));w.el.setLeft(A.startX-(w.el.getWidth()/2));b.calendar.element.select(&quot;div.&quot;+x.internalId,b.calendar.element.dom).each(function(B){if(B.dom!==w.el.dom){B.hide()}},this);Ext.util.Draggable.prototype.onStart.apply(this,arguments);b.calendar.fireEvent(&quot;eventdragstart&quot;,w,x,A);return true}})}var t=this.getCalendar().element.select(&quot;thead&quot;,this.getCalendar().element.dom).first().getHeight();var s=this.getCalendar().element.select(&quot;tbody&quot;,this.getCalendar().element.dom).first().getHeight();var o=this.getCalendar().element.select(&quot;tbody tr&quot;,this.getCalendar().element.dom).getCount();var d=s/o;var q=this.getCalendar().getStore().findBy(function(w){return w.get(&quot;date&quot;).getTime()===Ext.Date.clearTime(e.get(&quot;Date&quot;),true).getTime()},this);var p=Math.floor(q/7)+1;var r=t+(d*p);var v=e.get(&quot;BarPosition&quot;),l=e.get(&quot;BarLength&quot;),c=(this.getCalendar().element.getWidth()/7)*j.dom.cellIndex,i=j.getWidth(),n=m.getHeight(),g=this.getPlugin().getEventBarSpacing();m.setLeft(c+(u?0:g));m.setTop(r-n-(v*n+(v*g)+g));m.setWidth((i*l)-(g*(h?(h&amp;&amp;u?0:1):2)));if(e.linked().getCount()&gt;0){this.renderEventBars(e.linked())}},this)}});Ext.define(&quot;Ext.ux.TouchCalendarWeekEvents&quot;,{extend:&quot;Ext.ux.TouchCalendarMonthEvents&quot;});Ext.define(&quot;Ext.ux.TouchCalendarEvents&quot;,{extend:&quot;Ext.mixin.Observable&quot;,config:{viewModeProcessor:null,eventBarTpl:&quot;{title}&quot;,eventBarCls:&quot;event-bar&quot;,colourField:&quot;colour&quot;,cssClassField:&quot;css&quot;,eventHeight:&quot;duration&quot;,eventWidth:&quot;auto&quot;,startEventField:&quot;start&quot;,endEventField:&quot;end&quot;,eventWrapperCls:&quot;event-wrapper&quot;,eventBarSelectedCls:&quot;event-bar-selected&quot;,cellHoverCls:&quot;date-cell-hover&quot;,autoUpdateEvent:true,allowEventDragAndDrop:false,eventBarSpacing:1,eventWrapperEl:null},init:function(b){var a=this;this.calendar=b;this.calendar.eventsPlugin=this;this.calendar.refresh=Ext.Function.createSequence(this.calendar.refresh,this.refreshEvents,this);this.calendar.setViewMode=this.createPreSequence(this.calendar.setViewMode,this.onViewModeUpdate,this);this.calendar.onComponentResize=Ext.Function.createSequence(this.calendar.onComponentResize,this.onComponentResize,this);this.onViewModeUpdate(this.calendar.getViewMode())},onComponentResize:function(){var a=this;setTimeout(function(){a.refreshEvents()},200)},createPreSequence:function(b,c,a){if(!c){return b}else{return function(){c.apply(a||this,arguments);var d=b.apply(this,arguments);return d}}},onViewModeUpdate:function(a){this.setViewModeProcessor(Ext.create(this.getViewModeProcessorClass(a),{calendar:this.calendar,plugin:this}))},getViewModeProcessorClass:function(a){var b=&quot;&quot;;switch(a.toLowerCase()){case&quot;month&quot;:b=&quot;Ext.ux.TouchCalendarMonthEvents&quot;;break;case&quot;week&quot;:b=&quot;Ext.ux.TouchCalendarWeekEvents&quot;;break;case&quot;day&quot;:b=&quot;Ext.ux.TouchCalendarDayEvents&quot;;break}return b},refreshEvents:function(){if(this.calendar.getScrollable()){this.calendar.getScrollable().getScroller().scrollTo(0,0)}this.removeEvents();this.getViewModeProcessor().generateEventBars();this.createEventWrapper();if(this.getAllowEventDragAndDrop()){this.createDroppableRegion()}},createDroppableRegion:function(){var b=this;var a=0},onEventDropDeactivate:function(f,a,d,c){if(a.el.hasCls(this.eventBarCls)){var b=this.getEventRecord(a.el.getAttribute(&quot;eventID&quot;));this.calendar.element.select(&quot;div.&quot;+b.internalId,this.calendar.element.dom).each(function(e){e.show()},this)}},onEventDrop:function(f,a,d,c){var b=false;if(a.el.hasCls(this.eventBarCls)){this.calendar.all.each(function(e){var j=e.getPageBox(true);var k=a.el.getPageBox(true);if(j.partial(k)&amp;&amp;this.calendar.fireEvent(&quot;beforeeventdrop&quot;,a,f,g,d)){b=true;var g=this.getEventRecord(a.el.getAttribute(&quot;eventID&quot;)),h=this.calendar.getCellDate(e),i=this.getDaysDifference(g.get(this.getStartEventField()),h);if(this.getAutoUpdateEvent()){g.set(this.getStartEventField(),h);g.set(this.getEndEventField(),g.get(this.getEndEventField()).add(Date.DAY,i))}this.refreshEvents();this.calendar.fireEvent(&quot;eventdrop&quot;,a,f,g,d);return}},this);this.calendar.all.removeCls(this.getCellHoverCls());if(!b){a.setOffset(a.startOffset,true)}}},onEventDragStart:function(a,f){var d=a.el.getAttribute(&quot;eventID&quot;),b=this.getEventRecord(d),c=this.getEventBarRecord(d);a.el.setWidth(a.el.getWidth()/c.get(&quot;BarLength&quot;));a.updateBoundary(true);this.calendar.element.select(&quot;div.&quot;+b.internalId,this.calendar.element.dom).each(function(e){if(e.dom!==a.el.dom){e.hide()}},this);this.calendar.fireEvent(&quot;eventdragstart&quot;,a,b,f)},createEventWrapper:function(){if(this.calendar.rendered&amp;&amp;!this.getEventWrapperEl()){this.setEventWrapperEl(Ext.DomHelper.append(this.getEventsWrapperContainer(),{tag:&quot;div&quot;,cls:this.getEventWrapperCls()},true));this.getEventWrapperEl().on(&quot;tap&quot;,this.onEventWrapperTap,this,{delegate:&quot;div.&quot;+this.getEventBarCls()});if(this.getViewModeProcessor().eventBarStore){this.getViewModeProcessor().renderEventBars(this.getViewModeProcessor().eventBarStore)}}else{this.calendar.on(&quot;painted&quot;,this.createEventWrapper,this)}},onEventWrapperTap:function(g,f){g.stopPropagation();var d=g.getTarget(&quot;div.&quot;+this.getEventBarCls());if(d){var c=d.getAttribute(&quot;eventID&quot;),b=Ext.fly(d);if(c){var a=this.getEventRecord(c);this.deselectEvents();b.addCls(this.getEventBarSelectedCls());this.calendar.fireEvent(&quot;eventtap&quot;,a,g)}}},getEventsWrapperContainer:function(){return this.calendar.element.select(&quot;thead th&quot;,this.calendar.element.dom).first()||this.calendar.element.select(&quot;tr td&quot;,this.calendar.element.dom).first()},getEventRecord:function(a){var b=this.calendar.eventStore.findBy(function(c){return c.internalId===a},this);return this.calendar.eventStore.getAt(b)},getEventBarRecord:function(a){var b=this.eventBarStore.findBy(function(c){return c.get(&quot;EventID&quot;)===a},this);return this.eventBarStore.getAt(b)},deselectEvents:function(){this.calendar.element.select(&quot;.&quot;+this.getEventBarSelectedCls(),this.calendar.element.dom).removeCls(this.getEventBarSelectedCls())},getDaysDifference:function(b,a){b=b.clearTime(true).getTime();a=a.clearTime(true).getTime();return(a-b)/1000/60/60/24},removeEvents:function(){if(this.getEventWrapperEl()){this.getEventWrapperEl().dom.innerHTML=&quot;&quot;;this.getEventWrapperEl().destroy();this.setEventWrapperEl(null)}if(this.eventBarStore){this.eventBarStore.remove(this.eventBarStore.getRange());this.eventBarStore=null}if(this.droppable){this.droppable=null}},applyEventBarTpl:function(a){if(Ext.isString(a)||Ext.isArray(a)){a=Ext.create(&quot;Ext.XTemplate&quot;,a)}return a}});Ext.define(&quot;Ext.ux.CalendarEventBarModel&quot;,{extend:&quot;Ext.data.Model&quot;,config:{fields:[{name:&quot;EventID&quot;,type:&quot;string&quot;},{name:&quot;Date&quot;,type:&quot;date&quot;},{name:&quot;BarLength&quot;,type:&quot;int&quot;},{name:&quot;BarPosition&quot;,type:&quot;int&quot;},{name:&quot;Colour&quot;,type:&quot;string&quot;},&quot;Record&quot;],hasMany:[{model:&quot;Ext.ux.CalendarEventBarModel&quot;,name:&quot;linked&quot;}]}});Ext.define(&quot;Ext.util.Region.partial&quot;,{extend:&quot;Ext.util.Region&quot;,partial:function(g){var f=this,e=g.right-g.left,c=g.bottom-g.top,b=f.right-f.left,a=f.bottom-f.top,d=g.top&gt;f.top&amp;&amp;g.top&lt;f.bottom;horizontalValid=g.left&gt;f.left&amp;&amp;g.left&lt;f.right;return horizontalValid&amp;&amp;d}});Ext.define(&quot;Ext.ux.TouchCalendarSimpleEvents&quot;,{extend:&quot;Ext.mixin.Observable&quot;,startEventField:&quot;start&quot;,endEventField:&quot;end&quot;,multiEventDots:true,wrapperCls:&quot;simple-event-wrapper&quot;,eventDotCls:&quot;simple-event&quot;,dotWidth:6,eventTpl:['&lt;span class=&quot;{wrapperCls}&quot;&gt;','&lt;tpl for=&quot;events&quot;&gt;','&lt;span class=&quot;{[parent.eventDotCls]}&quot;&gt;&lt;/span&gt;',&quot;&lt;/tpl&gt;&quot;,&quot;&lt;/span&gt;&quot;].join(&quot;&quot;),filterFn:function(c,e,b){if(arguments.length===2){b=e}var a=Ext.Date.clearTime(c.get(this.startEventField),true).getTime(),d=Ext.Date.clearTime(c.get(this.endEventField),true).getTime(),b=Ext.Date.clearTime(b,true).getTime();return(a&lt;=b)&amp;&amp;(d&gt;=b)},init:function(a){this.calendar=a;this.calendar.simpleEventsPlugin=this;this.wrapperCls=this.wrapperCls+(this.multiEventDots?&quot;-multi&quot;:&quot;&quot;);this.eventDotCls=this.eventDotCls+(this.multiEventDots?&quot;-multi&quot;:&quot;&quot;);this.calendar.showEvents=this.showEvents;this.calendar.hideEvents=this.hideEvents;this.calendar.removeEvents=this.removeEvents;this.calendar.refresh=Ext.Function.createSequence(this.calendar.refresh,this.refreshEvents,this);this.calendar.syncHeight=Ext.Function.createSequence(this.calendar.syncHeight,this.refreshEvents,this)},refreshEvents:function(){if(!this.disabled&amp;&amp;this.calendar.getViewMode()!==&quot;DAY&quot;){var a=this.calendar.getStore();if(a){this.removeEvents();a.each(function(d){var f=d.get(&quot;date&quot;);var c=this.calendar.getDateCell(f);var e=this.calendar.eventStore;if(c){e.clearFilter();var b=e[this.multiEventDots?&quot;filterBy&quot;:&quot;findBy&quot;](Ext.bind(this.filterFn,this,[f],true));var i=e.getRange().length;if((!this.multiEventDots&amp;&amp;b&gt;-1)||(this.multiEventDots&amp;&amp;i&gt;0)){var h=Math.min((c.getWidth()/this.dotWidth),i);var g=new Ext.XTemplate(this.eventTpl).append(c,{events:(this.multiEventDots?e.getRange().slice(0,h):[&quot;event&quot;]),wrapperCls:this.wrapperCls,eventDotCls:this.eventDotCls},true);g.setWidth(Math.min((this.multiEventDots?e.getRange().length:1)*this.dotWidth,c.getWidth()));g.setY((c.getY()+c.getHeight())-(g.getHeight()+(c.getHeight()*0.1)));g.setX((c.getX()+(c.getWidth()/2))-(g.getWidth()/2)+2)}}},this)}}},hideEvents:function(){this.simpleEventsPlugin.disabled=true;this.calendar.element.select(&quot;span.&quot;+this.wrapperCls,this.calendar.element.dom).hide()},showEvents:function(){this.simpleEventsPlugin.disabled=false;this.calendar.element.select(&quot;span.&quot;+this.wrapperCls,this.calendar.element.dom).show()},removeEvents:function(){if(this.calendar.element){this.calendar.element.select(&quot;span.&quot;+this.wrapperCls,this.calendar.element.dom).each(function(a){Ext.destroy(a)})}}});</pre>
</body>
</html>
